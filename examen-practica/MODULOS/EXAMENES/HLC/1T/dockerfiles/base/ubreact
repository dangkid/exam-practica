FROM ubnginx:latest

# Instalar Node.js (v18) y herramientas de compilación
RUN apt-get update && apt-get install -y curl ca-certificates \
 && curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
 && apt-get install -y nodejs build-essential \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

# Directorio de la aplicación
WORKDIR /app

# Copiar archivos para instalar dependencias
COPY personal/pokeapi-app/package*.json ./

# Permitir pasar la URL de la API en tiempo de build
ARG REACT_APP_API_URL
ENV REACT_APP_API_URL=${REACT_APP_API_URL}
ENV NODE_ENV=production

# Instalar dependencias (incluye dev para poder construir)
RUN npm install

# Copiar el resto de la app y construir el bundle de producción
COPY personal/pokeapi-app/ ./
RUN npm run build

# Copiar el build a la raíz de nginx
RUN rm -rf /var/www/html/* || true
RUN cp -r build/* /var/www/html/

EXPOSE 80

# Arrancar nginx y ssh en primer plano y mantener el contenedor arriba
CMD ["/bin/bash", "-c", "service nginx start && service ssh start && tail -f /dev/null"]
